[env:esp32-p4]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip
board = esp32-p4
framework = arduino

; === FLASH & STORAGE ===
board_upload.flash_size = 16MB
board_build.partitions = default_16MB.csv
board_build.flash_mode = qio
board_build.f_flash = 80000000L         ; 80MHz flash speed (max for QIO)

; === PSRAM (32MB OPI) ===
board_build.psram_type = opi
board_build.f_psram = 200000000L        ; 200MHz PSRAM speed (OPI max)

; === CPU FREQUENCY ===
board_build.f_cpu = 360000000L          ; 360MHz dual-core RISC-V (max speed)

lib_ldf_mode = deep
lib_archive = false

extra_scripts = pre:remove_lvgl_asm.py

build_flags =
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DCORE_DEBUG_LEVEL=0
    -DLV_CONF_INCLUDE_SIMPLE
    -I.
    ; Optimization flags for RISC-V dual-core
    -O3
    -ffunction-sections
    -fdata-sections
    ; LVGL ASM disabled (RISC-V, not ARM)
    -DLV_USE_DRAW_SW_ASM=LV_DRAW_SW_ASM_NONE
    -DLV_USE_DRAW_SW_ASM_HELIUM=0
    -DLV_USE_DRAW_SW_ASM_NEON=0
    -Wno-deprecated-declarations
    ; ESP-IDF component access for PPA driver
    -Wl,-Map,firmware.map
    ; PSRAM XIP - Already includes FETCH_INSTRUCTIONS and RODATA in v3.1.1+
    -DCONFIG_SPIRAM_XIP_FROM_PSRAM=1
    ; WARNING: Flash chip (Boya BY25Q 0x684018) does NOT support suspend/resume!
    ; CONFIG_SPI_FLASH_AUTO_SUSPEND is USELESS - flash writes will ALWAYS block PSRAM
    ; Solution: vTaskDelay(1ms) after each Update.write() in ui_handlers.cpp
    ; Keeping flag enabled for future boards with supported flash (GD25QxxE, XM25QxxC)
    -DCONFIG_SPI_FLASH_AUTO_SUSPEND=1
    ; Allow scheduler to yield during flash erase (helps slightly but doesn't fix OTA flicker)
    -DCONFIG_SPI_FLASH_YIELD_DURING_ERASE=1
    ; NOTE: These RGB LCD configs don't apply to MIPI DSI but kept for compatibility
    -DCONFIG_ESP32P4_DATA_CACHE_LINE_64B=1
    -DCONFIG_LCD_RGB_RESTART_IN_VSYNC=1
    ; Reduce mbedTLS buffer sizes to save DMA memory for OTA (prevents SDIO crashes)
    -DCONFIG_MBEDTLS_SSL_IN_CONTENT_LEN=4096
    -DCONFIG_MBEDTLS_SSL_OUT_CONTENT_LEN=4096

build_unflags =

build_src_filter =
    +<*>
    +<fonts/*.c>
    -<.git/>
    -<.svn/>

upload_speed = 921600
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

lib_deps =
    lvgl/lvgl@^9.4.0
    tamctec/TAMC_GT911@^1.0.2
    bblanchon/ArduinoJson@^7.3.0
    bitbank2/PNGdec@^1.0.3
    ESP32Async/ESPAsyncWebServer
    ricmoo/QRCode@^0.0.1